\chapter{Database}

The main database is a PostgreSQL 10 database.
Additionally, the PostGIS plugin is installed into the database.
An easy way to obtain a base database system into which the schema can just be imported is to use the \verb!postgis/postgis:10-3.1! Docker image.


\section{Table Structure}

\begin{figure}[tb]
  \centering
  \includegraphics[width=\textwidth]{postgres/layout.pdf}
  \caption{%
    Schematic structure of the PostgreSQL database.
    The tables are represented by boxes, which in turn are grouped by function.
    Relationships between tables are indicated by arrows.
    }
  \label{fig:db-structure}
\end{figure}

\Cref{fig:db-structure} shows the schematic structure of the PostgreSQL database.
Tables are represented as boxes consisting of three parts, with the table name in the first part, the primary key (if it exists) in the second part, and the remaining columns in the third part.
Foreign key references are indicated by
\tikz{\path [use as bounding box] (0,0) -- (7mm,2mm); \draw [{Diamond[open]}-{Latex}] (0cm,1mm) -- (0.7cm,1mm);}
arrows with a diamond at the starting point.
Weak references are indicated with
\tikz{\path [use as bounding box] (0,0) -- (7mm,2mm); \draw [{Circle[open]}-{Latex}] (0cm,1mm) -- (0.7cm,1mm);}
open circles at the starting point, and one-to-many references\footnote{One-to-many references are realized with PostgreSQL arrays, and are weak references.}
\tikz{\path [use as bounding box] (0,0) -- (7mm,2mm); \draw [{Rays[n=6,length=1.6mm,width=1.6mm]}-Latex] (0cm,1mm) -- (0.7cm,1mm);}
are indicated with six rays at the starting point.
The tables are grouped by function.
The individual groups and tables are described in more detail in \cref{sec:data-tables,sec:provenance-tables}.


\subsection{Data Tables}
\label{sec:data-tables}

\begin{table}[htb]
  \centering
  \caption{Confidence values.}
  \label{table:confidence-values}
  \begin{tabular}{@{}rl@{}}
    \toprule
    Value & Comment \\
    \midrule
    \verb!false! & We know the information is not true. \\
    \verb!uncertain! & We are mostly convinced that the information is not true. \\
    \verb!contested! & We are unsure whether the information is true. \\
    \verb!probable! & We are mostly convinced that the information is true. \\
    \verb!certain! & We are as sure as one can be with historical information that the information is true. \\
    \bottomrule
  \end{tabular}
\end{table}

\begin{table}[htb]
  \centering
  \caption{Aspects of confidence.}
  \label{table:confidence-aspects}
  \begin{tabular}{@{}llp{8.5cm}@{}}
    \toprule
    Aspect & Table & Description \\
    \midrule
    Religion confidence & \verb!religion_instance! & How confident are we that this is the correct religion for the evidence? \\
    Person confidence & \verb!person_instance! & How confident are we that this is the correct person for the evidence? \\
    Location confidence & \verb!place! & How confident are we about the geographical location of this place? \\
    Place attribution confidence & \verb!place_instance! & How confident are we that this is the correct place for the evidence? \\
    Time confidence & \verb!time_instance! & How confident are we that this is the correct time span for the evidence? \\
    Interpretation confidence & \verb!evidence! & How confident are we in the general interpretation of this evidence? \\
    Source confidence & \verb!source_instance! & How confident are we that the information about the evidence we extracted from that source is correct? \\
    \bottomrule
  \end{tabular}
\end{table}

\paragraph{Data types.}
Most data columns have standard PostgreSQL data types such as \verb!text!, \verb!integer!, or \verb!boolean!.
Time and text ranges are stored as the PostgreSQL \verb!int4range! type, and geographical locations are stored in the PostgreSQL \verb!point! type.
To qualify the historical data, most tables also have a \emph{confidence} column, which contains a \verb!NULL!-able confidence value.
These are stored as an \verb!enum!, the contents of which are explained in \cref{table:confidence-values}.
For more details on our choice of levels of confidence and the confidence data model, please refer to our 2019 publication\footfullcite{Franke_2019}.
The aspects of confidence, and where they are stored, are explained in \cref{table:confidence-aspects}.
To accommodate for unstructured metadata and notes, most tables also have a \verb!NULL!-able \verb!comment! column.


\paragraph{Base data.}
Places, or cities, are stored in the \verb!place! table.
This contains the primary name for that place, its geographical location, if known, and a boolean flag indicating whether the place should be included in the visualization.
A place also has a place type (stored in the \verb!place_type! table).
Place types also have a visibility flag, which affects the visibility of all places with that type in the visualization.
Alternative names for places are stored as entries in the \verb!name_var! table.
An alternative name has a primary name, an optional transcription of the name (for example, if the name is in Arabic script), and optionally one or more simplified forms that can be used for full-text search.
For an alternative name, we also store which language (stored in the \verb!language! table) it is a name in, and whether it is a main form of the name that should be displayed to visitors.
Persons are stored in the \verb!person! table.
They have a type (stored in the \verb!person_type! table).
We also store a time range for persons, which is a free-text field.
The name combined with the time range must be unique;
for instance, there can be multiple persons with the name \emph{\enquote{Marcus},} but each must have a different time range; which could, for example, consist of a year range, or a qualifier such as \enquote{the Third.}
Finally, religions are stored in the \verb!religion! table, with their name, abbreviation, and color used in the visualization.
Religions are hierarchical, so a religion can optionally reference a parent religion.


\paragraph{External URIs.}
Part of the data collection effort was put into aligning our base data entities with those of other databases for historical data, such as Syriaca.org, the Digital Atlas of the Roman Empire (DARE), or Pleiades.
Such external databases are stored in the \verb!external_database! table with a long and short name, a URL, and a comment.
Namespaces for URIs in those databases are then stored in the \verb!uri_namespace! table, with a reference to the external database entry, a name, and a comment.
The URI namespace entry further contains a \emph{URI pattern,} which is a \verb!printf(3)!-style string with one \verb!%s! placeholder.
External URI references for places and persons are then stored in the \verb!external_place_uri! and \verb!external_person_uri! tables.
These reference the respective base datum and the URI namespace the URI is based on, and contain a comment.
They further contain a \emph{URI fragment}, which is the part of the URI that is represented by the placeholder in the URI namespace entry.
For example, the place \emph{Edessa} on Syriaca.org\footnote{\url{http://syriaca.org/place/78}} could be represented by a URI namespace with the URI pattern \verb!http://syriaca.org/place/%s! and a external place URI entry with the URI fragment \verb!78!.
The structuring of these tables means that
\begin{enumerate*}[label=(\arabic*)]
  \item an external database can have more than one URI namespace,
  \item only storing the fragment in the URI references reduces data entry errors, and
  \item it is easier to update all URIs of a database in case it moves hosts\footnote{%
      This happened with DARE in 2019, when the old site at \url{http://dare.ht.lu.se} was deactivated and moved to \url{https://dh.gu.se/dare/}.
      The new site, however, was not as functional.
      The creator Johan Ã…hlfeldt then re-hosted everything at \url{https://imperium.ahlfeldt.se}, but all already-entered URIs had to be updated.
      }.
\end{enumerate*}


\paragraph{Documents and annotations.}
Historical sources are stored in the \verb!source! table with a long and short version of their name, where the long version is a proper citation.
A source also has a source type, which is a reference to an entry in the \verb!source_type! table, as well as a default interpretation confidence value, which is suggested for new source instances (see paragraph \enquote{Evidence} on p.~\pageref{par:evidence}).
Digital versions of sources can be stored in the \verb!document! table.
A document references its source, has a version number, a comment, content type and content length fields, and the content itself, which is a byte array.
Documents can be annotated, and these annotations are then stored in the \verb!annotation! table with a reference to the document, the start and end position of the annotation as an \verb!int4range! range, and a comment.
Annotations are used in evidence parts (see paragraph \enquote{Evidence part data} on p.~\pageref{par:evidence-part-data}), and based on data already in the database, new annotations are suggested (see also~\cref{sec:annotator}).
These are stored in the \verb!annotation_suggestion! table with some metadata, alongside a \emph{weak reference} to the base datum (place, person, or religion) they refer to.
The weak reference consists of an ID and a type string, which can be one of \verb!'place'!, \verb!'person'!, or \verb!'religion'!.
Because recalculating the suggestions is expensive, intermediate hashes that only change if there might be new suggestion results are stored for each document in the \verb!annotation_suggestion_document_state! table, and the annotation suggestions are only recalculated if the calculated hashes do not match the stored ones.


\paragraph{Evidence part data.}\label{par:evidence-part-data}
For each piece of historical evidence, \emph{instances} of the base data are created.
An instance contains a reference to the respective datum, a confidence value, and a comment.
Additionally, it may contain a reference to an annotation.
Instances for places, persons, and religions are stored in the \verb!place_instance!, \verb!person_instance!, and \verb!religion_instance! tables, respectively.
Time spans are grouped via the \verb!time_group! table, which consists of only an ID column, and an optional reference to an annotation.
Individual time spans are stored in the \verb!time_instance! table, with a confidence value, a comment, and a reference to the time group.
The time span itself is stored as an \verb!int4range!; that is, time is stored in years.


\paragraph{Evidence.}\label{par:evidence}
Pieces of historical evidence are stored in the \verb!evidence! table.
Evidence consists of a time group, a place instance, a religion instance, and optionally a person instance.
Instances may be part of multiple evidences, which is a typical use case with the annotation system (see~\cref{sec:annotator}), but are often connected to only one evidence.
Each evidence tuple also has a visibility flag, as well as a confidence value and a comment.
Evidence tuples can be \emph{tagged} with zero to many tags to categorize them.
Tags are stored in the \verb!tag! table, with a short name and a comment.
Evidence is attributed to tags via entries in the \verb!tag_evidence! table.
Evidence can also be attributed to zero to many sources via the \verb!source_instance! table.
Each source instance references a source and an evidence and also contains a free-text page reference in the source, the interpretation confidence value for that evidence, and a comment.



\subsection{Provenance}
\label{sec:provenance-tables}

For provenance, data edits relating to evidence tuples are recorded in the \verb!user_action! table.
This stores a reference to the evidence and the type of action (a reference to an entry in the \verb!action_type! table, but typically one of \textsc{Create}, \textsc{Update}, or \textsc{Delete}), alongside a timestamp, a short description of the action, and the old data entry value before the change, if it exists.
Further, the user that did the change is recorded, which is a reference to an entry in the \verb!users! table.
This table needs to contain an entry for each user that can log in to the front-end and has the \verb!writedb! role (see also~\cref{sec:user-authentication}).


\section{Roles}
\section{Backups}
\section{Other Databases}
\subsection{User Database}
\subsection{Report Database}
